@using LocalOfferts.Data
@using LocalOfferts.Service
@using Microsoft.AspNetCore.Http
@using BlazorInputFile

@page "/addproduct"
@inject NavigationManager NavigationManager
@inject IProductService ProductService
@inject IHttpContextAccessor httpContextAccessor
@inject IFileUpload fileUpload

<div class="oi-header">
    <h2 class="text-black-50 text-center "> Dodaj Produkt</h2>
    <br />
</div>

<div class="col-md-7" style="margin:0 auto;">
    <div class="card">
        <div class="card-body">
            <form>
                <div class="form-group">
                    <EditForm Model="@product">
                        <InputFile OnChange="HandleFileSelected"></InputFile>
                    </EditForm>
                </div>
                <div class="form-group">
                    <label for="ProductName" class="col-form-label">Nazwa Produktu</label>
                    <input for="ProductName" class="form-control" @bind="@product.ProductName" />
                </div>
                <div class="form-group">
                    <label for="ProductPrice" class="col-form-label">Cena</label>
                    <input type="number" step="0.01" for="ProductPrice" class="form-control" @bind="@product.ProductPrice" />
                </div>
                <div class="form-group">
                    <label for="ProductDescripion" class="col-form-label">Opis Produktu</label>
                    <textarea class="form-control" @bind="@product.ProductDescription" rows="3" />
                </div>
                <div class="form-group">
                    <label for="ShopeName" class="col-form-label">Nazwa Sklepu</label>
                    <input for="ShopeName" class="form-control" @bind="@product.ShopeName" />
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <input type="button" class="btn btn-success" @onclick="@CreateProduct" value="Save" />
                            <input type="button" class="btn btn-warning" @onclick="@Cancel" value="Cancel" />
                        </div>
                    </div>
                </div>

            </form>
        </div>

    </div>
</div>






@code {

    Product product = new Product();

    public byte[] ImageUpload { get; set; }
    private string userName;


    protected override async Task OnInitializedAsync()
    {
        userName = httpContextAccessor.HttpContext.User.Identity.Name;
    }

    protected async Task CreateProduct()
    {
        product.Image = ImageUpload;
        await ProductService.CreateProduct(product, userName);
        NavigationManager.NavigateTo("indexproduct");
    }

    void Cancel()
    {
        NavigationManager.NavigateTo("indexproduct");
    }

    async Task HandleFileSelected(IFileListEntry[] files)
    {
        var file = files.FirstOrDefault();
        if (file != null)
        {
            var ms = new MemoryStream();
            await file.Data.CopyToAsync(ms);
            ImageUpload = ms.ToArray();
        }


    }


}
